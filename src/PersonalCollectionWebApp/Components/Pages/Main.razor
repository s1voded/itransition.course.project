@page "/"
@attribute [Authorize(Policy = PolicyUserNotBlockedOrAnonymous)]
@rendermode @(new InteractiveServerRenderMode(false))
@inject CollectionService CollectionService
@inject ItemService ItemService
@inject NavigationManager NavigationManager
@inject PageHelperService PageHelperService
@inject IStringLocalizer<Main> locale
@inject IJSRuntime JS

<PageTitle>@locale["Main"]</PageTitle>

<MudTable T="Item" Items="@lastAddedItems" Hover="true" Dense="true" OnRowClick="@NavigateToItemDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@locale["Last added items"]</MudText>
    </ToolBarContent>
    <ColGroup>
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
    </ColGroup>
    <HeaderContent>
        <MudTh>@locale["Name"]</MudTh>
        <MudTh>@locale["Collection"]</MudTh>
        <MudTh>@locale["Author"]</MudTh>
        <MudTh>@locale["Added"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Collection">@context.Collection.Name</MudTd>
        <MudTd DataLabel="Author">@context.Collection.User.UserName</MudTd>
        <MudTd DataLabel="Added">@PageHelperService.GetLocalTime(context.CreatedDate, timeZoneOffset)</MudTd>
    </RowTemplate>
</MudTable>

<MudDivider DividerType="DividerType.Middle" Class="my-2" />

<MudTable T="Collection" Items="@largestCollections" Hover="true" OnRowClick="@NavigateToCollectionDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@locale["Largest collections"]</MudText>
    </ToolBarContent>
    <ColGroup>
        <col style="width: 4%;" />
        <col style="width: 24%;" />
        <col style="width: 24%;" />
        <col style="width: 24%;" />
        <col style="width: 24%;" />
    </ColGroup>
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh>@locale["Name"]</MudTh>
        <MudTh>@locale["Theme"]</MudTh>
        <MudTh>@locale["Author"]</MudTh>
        <MudTh>@locale["Items count"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            @if (!string.IsNullOrEmpty(context.Image))
            {
                <MudAvatar Rounded="true" Color="Color.Transparent" Size="Size.Large">
                    <ImageComponent FileName="@context.Image" />
                </MudAvatar>
            }
        </MudTd>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Theme">@context.Theme?.Name</MudTd>
        <MudTd DataLabel="Author">@context.User.UserName</MudTd>
        <MudTd DataLabel="Items count">@context.Items.Count</MudTd>
    </RowTemplate>
</MudTable>

<MudDivider DividerType="DividerType.Middle" Class="my-2" />

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h6" Class="pa-2">@locale["Tags"]</MudText>
    @foreach (var tag in tagsWithUsedCount)
    {
        <MudLink Href="@PageHelperService.GetTagSearchHref(tag.Name)" Style=@($"font-size: {PageHelperService.GetFontSizeForTag(tag, minCountTags, maxCountTags)}px;") Class="pa-2">@tag.Name</MudLink>
    }
</MudPaper>


@code {
    private IEnumerable<Item> lastAddedItems = [];
    private IEnumerable<Collection> largestCollections = [];
    private IEnumerable<TagDto> tagsWithUsedCount = [];
    private int countLargestCollections = 5, countLastAddedItems = 5;
    private int timeZoneOffset, minCountTags, maxCountTags;

    protected override async Task OnInitializedAsync()
    {
        largestCollections = await CollectionService.GetLargestCollections(countLargestCollections);
        lastAddedItems = await ItemService.GetLastAddedItems(countLastAddedItems);

        tagsWithUsedCount = await ItemService.GetTagsWithUsedCount();
        minCountTags = tagsWithUsedCount.Min(t => t.Count);
        maxCountTags = tagsWithUsedCount.Max(t => t.Count);

        timeZoneOffset = await JS.InvokeAsync<int>(JSGetTimeOffsetFuncName);
    }

    private void NavigateToCollectionDetails(TableRowClickEventArgs<Collection> collection)
    {
        NavigationManager.NavigateTo($"/{NavCollections}/{collection.Item.Id}");
    }

    private void NavigateToItemDetails(TableRowClickEventArgs<Item> args)
    {
        NavigationManager.NavigateTo($"/{NavItems}/{args.Item.Id}");
    }
}