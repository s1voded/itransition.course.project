@page "/"
@attribute [Authorize(Policy = Constants.PolicyUserNotBlockedOrAnonymous)]
@rendermode InteractiveServer
@inject CollectionService CollectionService
@inject NavigationManager NavigationManager

<PageTitle>Home</PageTitle>

<MudTable T="Item" Items="@lastAddedItems" Hover="true" Dense="true" OnRowClick="@NavigateToItemDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Last added items</MudText>
    </ToolBarContent>
    <ColGroup>
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
    </ColGroup>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Collection</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Added</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Collection">@context.Collection.Name</MudTd>
        <MudTd DataLabel="Author">@context.Collection.User.UserName</MudTd>
        <MudTd DataLabel="Added" >@context.CreatedDate.ToLocalTime()</MudTd>
    </RowTemplate>
</MudTable>

<MudDivider DividerType="DividerType.Middle" Class="my-2" />

<MudTable T="Collection" Items="@largestCollections" Hover="true" Dense="true" OnRowClick="@NavigateToCollectionDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Largest collections</MudText>
    </ToolBarContent>
    <ColGroup>
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
        <col style="width: 25%;" />
    </ColGroup>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Theme</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Items count</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Theme">@context.Theme?.Name</MudTd>
        <MudTd DataLabel="Author">@context.User.UserName</MudTd>
        <MudTd DataLabel="Items count">@context.Items.Count</MudTd>
    </RowTemplate>
</MudTable>

<MudDivider DividerType="DividerType.Middle" Class="my-2" />

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h6">Tags</MudText>
    <MudStack Row="true">
        @foreach (var tag in tagsWithUsedCount)
        {
            <MudLink Href="@GetHref(tag.Name)">@tag.Name</MudLink>
        }
    </MudStack>
</MudPaper>


@code {
    private IEnumerable<Item> lastAddedItems = [];
    private IEnumerable<Collection> largestCollections = [];
    private IEnumerable<TagDto> tagsWithUsedCount = [];
    private int countLargestCollections = 5;
    private int countLastAddedItems = 5;

    protected override async Task OnInitializedAsync()
    {
        lastAddedItems = await CollectionService.GetLastAddedItems(countLastAddedItems);
        largestCollections = await CollectionService.GetLargestCollections(countLargestCollections);
        tagsWithUsedCount = await CollectionService.GetTagsWithUsedCount();
    }

    private void NavigateToCollectionDetails(TableRowClickEventArgs<Collection> collection)
    {
        NavigationManager.NavigateTo($"/{Constants.NavCollections}/{collection.Item.Id}");
    }

    private void NavigateToItemDetails(TableRowClickEventArgs<Item> args)
    {
        NavigationManager.NavigateTo($"/{Constants.NavItems}/{args.Item.Id}");
    }

    private string GetHref(string tagName)
    {
        return $"/search?SearchTag={tagName}";
    }
}