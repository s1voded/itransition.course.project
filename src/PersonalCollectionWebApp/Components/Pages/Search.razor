@attribute [Route(AppRouteSearch)]
@attribute [Authorize(Policy = PolicyUserNotBlockedOrAnonymous)]
@rendermode @(new InteractiveServerRenderMode(false))
@inject CollectionService CollectionService
@inject NavigationManager NavigationManager

<PageTitle>Search items</PageTitle>

<MudTable T="Item" Items="@foundItems" Hover="true" Dense="true" OnRowClick="@NavigateToItemDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Found items</MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<Item, object>(x=>x.Name)">Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Item, object>(x=>x.Collection.Name)">Collection</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Item, object>(x=>x.Collection.User?.UserName)">Author</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Item, object>(x=>x.CreatedDate)">Added</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<Item, object>(x=>x.Tags?.Count)">Tags</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Collection">@context.Collection.Name</MudTd>
        <MudTd DataLabel="Author">@context.Collection.User.UserName</MudTd>
        <MudTd DataLabel="Added">@context.CreatedDate.ToLocalTime()</MudTd>
        <MudTd DataLabel="Tags">@string.Join(", ", context.Tags.Select(t => t.Name))</MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
    </PagerContent>
</MudTable>

@code {
    [SupplyParameterFromQuery]
    public string? SearchString { get; set; }

    [SupplyParameterFromQuery]
    public string? SearchTag { get; set; }

    private IEnumerable<Item> foundItems = [];

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(SearchString))
        {
            foundItems = await CollectionService.SearchItems(SearchString);
        }

        if (!string.IsNullOrEmpty(SearchTag))
        {
            foundItems = await CollectionService.SearchItemsByTag(SearchTag);
        }
    }

    private void NavigateToItemDetails(TableRowClickEventArgs<Item> args)
    {
        NavigationManager.NavigateTo($"/{NavItems}/{args.Item.Id}");
    }
}
