@attribute [Route(AppRouteSearch)]
@rendermode InteractiveServer
@inject CollectionService CollectionService
@inject NavigationManager NavigationManager

<PageTitle>Search items</PageTitle>

<MudTable T="Item" Items="@foundItems" Hover="true" Dense="true" OnRowClick="@NavigateToItemDetails" RowClass="cursor-pointer">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Found items</MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Collection</MudTh>
        <MudTh>Author</MudTh>
        <MudTh>Added</MudTh>
        <MudTh>Tags</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Collection">@context.Collection.Name</MudTd>
        <MudTd DataLabel="Author">@context.Collection.User.UserName</MudTd>
        <MudTd DataLabel="Added">@context.CreatedDate.ToLocalTime()</MudTd>
        <MudTd DataLabel="Tags">@string.Join(", ", context.Tags.Select(t => t.Name))</MudTd>
    </RowTemplate>
</MudTable>

@code {
    [SupplyParameterFromQuery]
    public string? SearchString { get; set; }

    [SupplyParameterFromQuery]
    public string? SearchTag { get; set; }

    private IEnumerable<Item> foundItems = [];

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(SearchString))
        {
            foundItems = await CollectionService.SearchItems(SearchString);
        }

        if (!string.IsNullOrEmpty(SearchTag))
        {
            foundItems = await CollectionService.SearchItemsByTag(SearchTag);
        }
    }

    private void NavigateToItemDetails(TableRowClickEventArgs<Item> args)
    {
        NavigationManager.NavigateTo($"/{NavItems}/{args.Item.Id}");
    }
}
